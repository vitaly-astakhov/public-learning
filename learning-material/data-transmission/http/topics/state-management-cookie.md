# State Management (Cookie)

## Documentation
- [ ] [Cookies: HTTP State Management Mechanism](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html)

___

Используя поле заголовка `Set-Cookie`, HTTP-сервер может передавать пары имя/значение и связанные метаданные (называемые файлами cookie) пользовательскому агенту. Когда пользовательский агент выполняет последующие запросы к серверу, пользовательский агент использует метаданные и другую информацию, чтобы определить, следует ли возвращать пары имя/значение в поле заголовка `Cookie`.


Для хранения состояния исходный сервер включает поле заголовка `Set-Cookie` в ответ HTTP. В последующих запросах пользовательский агент возвращает поле заголовка запроса `Cookie` исходному серверу. Поле заголовка `Cookie` содержит файлы cookie, которые пользовательский агент получил в предыдущих полях заголовка `Set-Cookie`. Исходный сервер (**origin server**) может игнорировать поле заголовка `Cookie` или использовать его содержимое для целей, определяемых приложением.

Когда пользовательский агент получает поле заголовка `Set-Cookie`, пользовательский агент сохраняет файл cookie вместе с его атрибутами. Впоследствии, когда пользовательский агент выполняет HTTP-запрос, пользовательский агент включает применимые файлы cookie с неистекшим сроком действия в поле заголовка `Cookie`.

### Server

Исходные серверы **       (MAY)** отправлять поле заголовка ответа `Set-Cookie` с любым ответом. Исходный сервер может включать несколько полей заголовка `Set-Cookie` в один ответ. Наличие поля заголовка `Cookie` или `Set-Cookie` не препятствует сохранению и повторному использованию ответа HTTP-кэшами.

Исходные серверы **НЕ ДОЛЖНЫ (SHOULD NOT)** объединять несколько полей заголовка `Set-Cookie` в одно поле заголовка. Это является [исключением из правил](https://datatracker.ietf.org/doc/html/rfc9110#name-field-order).

### User Agent

Пользовательские агенты **МОГУТ (MAY)** игнорировать поля заголовка `Set-Cookie` на основе кодов состояния ответа или политики файлов cookie (**cookie policy**) пользовательского агента.

Если пользовательский агент получает новый файл cookie с тем же именем файла cookie (cookie-name), значением домена (domain-value) и значением пути (path-value), что и файл cookie, который он уже сохранил, существующий файл cookie удаляется и заменяется новым файлом cookie. Обратите внимание, что серверы могут удалять файлы cookie, отправляя пользовательскому агенту новый файл cookie с атрибутом Expires со значением в прошлом.

Пользовательские агенты **ДОЛЖНЫ (SHOULD)** предоставлять пользователю механизм для выключения (disabling) файлов cookie. Если пользователь решил "выключить" куки, то пользовательский агент **НЕ ДОЛЖЕН (MUST NOT)** обрабатывать файлы cookie через поле `Set-Cookie`, и **НЕ ДОЛЖЕН (MUST NOT)** отсылать файлы cookie через поле `Cookie`


## Fields

### Cookie Attributes

### Expires
**Expires** - этот cookie аттрибут указывает максимальный срок действия файла cookie, представленный в виде даты и времени истечения срока действия файла cookie.

Пользовательский агент **ДОЛЖЕН (MUST )** ограничить максимальное значение атрибута `Expires`. Ограничение **НЕ ДОЛЖНО (SHOULD NOT)** превышать 400 дней (34560000 секунд) в будущем. **РЕКОМЕНДУЕМЫЙ (RECOMMENDED)** лимит составляет 400 дней в будущем, но [пользовательский агент **МОЖЕТ (MAY)** скорректировать этот лимит](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#cookie-policy). Атрибуты `Expires`, которые превышают лимит, **ДОЛЖНЫ (MUST)** быть уменьшены до этого предела.

### Max-Age
**Max-Age** - этот cookie аттрибут указывает максимальное время жизни файла cookie, представленное в виде количества секунд до истечения срока действия файла cookie

Пользовательский агент **ДОЛЖЕН (MUST )** ограничить максимальное значение атрибута `Max-Age`. Ограничение **НЕ ДОЛЖНО (SHOULD NOT)** превышать 400 дней (34560000 секунд) в будущем. **РЕКОМЕНДУЕМЫЙ (RECOMMENDED)** лимит составляет 400 дней в будущем, но [пользовательский агент **МОЖЕТ (MAY)** скорректировать этот лимит](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#cookie-policy). Атрибуты `Max-Age`, которые превышают лимит, **ДОЛЖНЫ (MUST)** быть уменьшены до этого предела.

Некоторые существующие пользовательские агенты не поддерживают атрибут `Max-Age`. Пользовательские агенты, которые не поддерживают атрибут `Max-Age`, игнорируют этот атрибут.

Если файл cookie имеет как атрибут `Max-Age`, так и атрибут `Expires`, атрибут `Max-Age` имеет приоритет и контролирует дату истечения срока действия файла cookie. Если файл cookie не имеет ни атрибута `Max-Age`, ни атрибута `Expires`, пользовательский агент будет хранить файл cookie до тех пор, пока «текущий сеанс не завершится» (как определено пользовательским агентом).

### Domain
**Domain** - этот cookie аттрибут указывает те хосты, на которые будет отправлен файл cookie.

Если сервер не указывает атрибут `Domain`, пользовательский агент вернет файл cookie только исходному серверу (**origin server**).

**ПРЕДУПРЕЖДЕНИЕ**: Некоторые существующие пользовательские агенты обрабатывают отсутствующий атрибут домена так, как если бы атрибут домена присутствовал и содержал текущее имя хоста

Пользовательский агент будет отклонять файлы cookie, если атрибут `Domain` не указывает область действия файла cookie, которая будет включать исходный сервер. Подробнее: [Источник](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#section-4.1.2.3-3)

### Path
**Path** - этот cookie аттрибут указывает набор путей ограничивающих область действия каждого файла cookie.

Если сервер  не указывает атрибут `Path`, пользовательский агент будет использовать "каталог" (directory)  компонента path запроса-uri в качестве значения по умолчанию.

Пользовательский агент включит файл cookie в HTTP-запрос только в том случае, если часть пути запроса-uri соответствует (или является подкаталогом) атрибуту пути файла cookie, где символ %x2F («/») интерпретируется как разделитель каталогов.

Пользовательский агент

### Secure
**Secure** - этот cookie аттрибут ограничивает область действия файла cookie "защищенными" каналами ("защищенность" определяется агентом пользователя)

Если файл cookie имеет атрибут `Secure`, агент пользователя включит файл cookie в HTTP-запрос только в том случае, если запрос передается по защищенному каналу. Например: `HTTPS` или `WSS`

### HttpOnly
**HttpOnly** - этот cookie аттрибут ограничивает область действия файла cookie для HTTP-запросов. В частности, атрибут предписывает агенту пользователя не использовать файл cookie при предоставлении доступа к файлам cookie через API, отличные от HTTP

Этот атрибут предписывает агенту пользователя не использовать файл cookie при предоставлении доступа к файлам cookie через API, чей протокол отличается от HTTP. Например отправлять файл cookie не будет отправляться по вебсокетам по протоколу `ws`.

При этом атрибут `HttpOnly` не зависит от атрибута `Secure`: файл cookie может иметь как атрибут `HttpOnly`, так и атрибут `Secure`. То есть, если оба аттрибута находятся в файле cookie, то пользовательский агент будет отправлять файл cookie только если путь запроса будет содержать "https" схему в URI.

### SameSite
**SameSite** - этот cookie аттрибут ограничивает область действия файла cookie таким образом, что он будет прикрепляться к запросам только в том случае, если эти запросы относятся к одному сайту, [как определено алгоритмом](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#same-site-requests).

Это поле принимает только для значения:
- **Strict** - это значение гарантирует, что пользовательский агент отправит файл cookie только вместе с запросами к «тому же сайта» ("same-site"). Похоже на политику "strict-origin" из [концепции referrer 📂](./origin.md)
- **Lax** ([default](https://web.dev/articles/samesite-cookies-explained#samesitelax_by_default)) - это значение гарантирует, что пользовательский агент отправит файл cookie только вместе с запросами к «тому же сайта» ("same-site") и с "межсайтовыми" ("cross-site") навигациями верхнего уровня, [как указано тут](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#strict-lax).
- **None** - это значение гарантирует, что пользовательский агент отправит файл cookie всем сайтам.

Атрибут `SameSite` влияет на создание и доставку файлов cookie. Файлы cookie, в которых указано `SameSite=Lax` или `SameSite=Strict`, не могут быть установлены в ответ на межсайтовые запросы подресурсов или вложенные переходы между сайтами. Их можно установить вместе с любой навигацией верхнего уровня, межсайтовой или иной.

Создавая межсайтовые файлы cookie с использованием `SameSite=None`, надо добавлять аттрибут `Secure`, чтобы браузер мог их принимать. Подробнее: [Источник](https://web.dev/articles/samesite-cookies-explained#samesitenone_must_be_secure)

___

### [Prefixes](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#name-cookie-name-prefixes)

Префиксы в именах файлов cookie регламентируют необходимость передачи аттрибутов.

Пользовательские агенты **ДОЛЖНЫ (MUST)** сопоставлять префиксы имен файлов cookie [без учета регистра](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#name-cookie-name-prefixes-2), так как некоторые серверы обрабатывают файлы cookie без учета регистра.

Пример: [Cookie Prefixes Sample](https://googlechrome.github.io/samples/cookie-prefixes/)

___

#### [The "__Secure-" Prefix](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#name-the-__secure-prefix)

Если имя файла cookie начинается с совпадения строки `__Secure-` с учетом регистра, то для файла cookie необходим атрибут `Secure`.


#### [The "__Host-" Prefix](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#name-the-__host-prefix)

Если имя файла cookie начинается с совпадения с учетом регистра для строки `__Host-`, то для файла cookie необходим атрибут `Secure` и атрибут `Path` со значением "/" и должен отсутствовать атрибут `Domain`.

___

### Set-Cookie 🎩⬅️
**Set-Cookie** - это поле используется для отправки файлов cookie с сервера пользовательскому агенту, где файлы cookie будут хранится.

Серверы **НЕ ДОЛЖНЫ (SHOULD NOT)** создавать два атрибута с одинаковым именем в одной строке set-cookie-string.

Серверы **НЕ ДОЛЖНЫ (SHOULD NOT)** включать более одного поля заголовка `Set-Cookie` в один и тот же ответ с одним и тем же именем файла cookie.

Пользовательские агенты **МОГУТ (MAY)** игнорировать поля заголовка `Set-Cookie`, содержащиеся в ответах с кодами состояния [Informational 1xx](https://www.rfc-editor.org/rfc/rfc9110.html#name-informational-1xx) или на основании своей политики использования файлов cookie.

Если в строке "name-value-pair" пропущен символ %x3D ("="), тогда пользовательский агент обрабатывает строку имени ("name") как пустую, а строка значения ("value") - это значение пары имя-значение. [Источник](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#section-5.5-7.3.1).

Пользовательские агенты не сохраняют cookie файл, а точнее игнорируют поле `Set-Cookie`, если сумма длин строки имени и строки значения превышает 4096 октетов.

При получении куки файла, пользовательские агенты сохраняет следующие поля для каждого файла cookie: name, value, expiry-time, domain, path, creation-time, last-access-time, persistent-flag, host-only-flag, secure-only-flag, http-only-flag, и same-site-flag. [Подробнее](https://www.ietf.org/archive/id/draft-ietf-httpbis-rfc6265bis-13.html#section-5.6).

### Cookie 🎩➡️
**Cookie** - это поле используется для отправки сохраненных файлов cookie с пользовательского агента на исходный сервер. Поле `Cookie` передает значение `key=value` из файла cookie и не передает аттрибуты файла cookie.

Поле заголовка `Cookie` содержит файлы cookie, которые пользовательский агент получил в предыдущих полях `Set-Cookie`.

___

При работе в HTML файлами куки можно управлять через аттрибут документа `document.cookie`. Подробнее: [HTML spec](https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie).
